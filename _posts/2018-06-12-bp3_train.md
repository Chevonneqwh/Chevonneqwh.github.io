---
layout: post
title: "BP神经网络手写体识别（三）训练BP神经网络"
date: 2018-06-12
tag: BP神经网络
---



<br>随机选取一定数目的训练样本，以此训练BP神经网络

<br>



### 1. 网络结构初始化

- 主要是设置一些参数

  - 各层节点数
  - 权值阈值初始化
  - BP训练参数

- 代码如下

  ```matlab
  % 各层节点数
  inNum = 400;
  midNum = 100;
  outNum = 10;
  
  % 权值阈值初始化 rands (-1, 1)
  w1 = rands(inNum, midNum);  % 输入层和隐含层的连接权值：400行 25列
  b1 = rands(1, midNum);      % 隐含层节点的阈值：        1行   25列
  w2 = rands(midNum, outNum); % 隐含层和输出层的连接权值：25行  10列
  b2 = rands(1, outNum);      % 输出层节点的阈值：        1行   10列
  
  % 训练参数
  epoch = 200; % 最大迭代次数——算法结束有2个条件：达到最大迭代次数 & 预测误差小于给定值
  Eta = 0.1; % 学习率
  Upsilon = 0.1; % 收敛误差
  Hin = zeros(1, midNum);     % 隐含层输入
  Hout = zeros(1, midNum);    % 隐含层输出
  Emid = zeros(1, midNum);    % 隐含层误差
  Eout = zeros(1, outNum);    % 输出层误差
  ```

  

<br>



### 2. 网络训练

**2.0 流程图** 

![](/images/posts/bp/1_BP.png)

**2.1 正向传播**

- 样本在BP神经网络中分别经过输入层、隐含层、输出层的正向传播
- 得到网络预测输出

**2.2 反向传播**

- 反向传播，分别求出输出层和隐含层的误差
- 修正权值阀值

**2.3 几点说明**

- 最初实现的BP神经网络，对测试集进行分类时，将所有类别的图片都归为了第10类，即数字9；故测试集数字0-8的识别率均为0，数字9的识别率为100%；因此，总识别率只有10%左右；

- 寻找问题产生的原因

- 首先认为是数据的问题，可能是读取的测试集的数据格式不对等问题......但是，又拿这个网络去测试训练集的数据（这些数据都是刚刚用于训练网络的数据），得到的识别率还是在10%左右；由此，可以大致确定，出现问题的地方在BP神经网络的算法处

- 之后重新整理了算法的思路，发现自己之前对于BP神经网络的理解很多地方都是片面甚至错误的

  - 隐含层和输出层都有激活函数，并不是只有隐含层有
  - 反向传播求输出层和隐含层的误差，这里要注意隐含层和输出层都要求相应误差，且它们的计算方法不同
  - 根据误差修正权值阈值，这里要注意是根据哪个误差修正权值阈值？是根据上面求出的隐含层和输出层的误差
  - BP神经网络的特点是信号向前传播，误差反向传播；一定要理解反向传播的具体含义

- 最后重新整理了公式，并编码实现。

- 以上思路参考了课件的一张图片

  ![](/images/posts/bp/3_21.png)



**2.4 代码**

以上步骤的代码如下

``` matlab
trNum = 10*limit;
E=zeros(1,epoch);
for u = 1:epoch
    E(u) = 0; % 预测误差
    for v = 1:trNum % trNum个样本点
       %% 正向传播——网络预测输出
        x = input_train(v,:);  % 第v行：第v个样本点的特征值
        for j = 1:midNum   % midNum = 25   产生25个隐含层输入
            Hin(j) = x * w1(:,j) + b1(j);  % 隐含层输入  行向量：1行25列   （——3000*25）
            Hout(j) = 1/(1+exp(-Hin(j)));  % 隐含层输出     行向量：1行25列(1*25)
        end
        yi = Hout * w2 + b2; % 输出层输出    3000*25 25*10————3000*10 （1行10列）
        yn = 1./(1+exp(-yi));
        
       %% 权值阀值修正
        % 计算预测误差
        e = output_train(v,:) - yn;  % 行向量：1行10列（1*10）
        E(u) = (E(u)+sum(e.*e))*0.5;
        % 反向传播求各层误差
        for k = 1:outNum
            Eout(k) = yn(k)*(1-yn(k))*e(k);  % 输出层各节点误差：1*10
        end
        for j = 1:midNum
            Emid(j) = Hout(j)*(1-Hout(j))*w2(j,:)*Eout'; % 隐含层各节点误差：1*25
        end
        % 更新权值阈值
        w1 = w1+Eta*x'*Emid;  % 400*25
        w2 = w2+Eta*Hout'*Eout; % 25*10
        b1 = b1+Eta*Emid; % 1*25
        b2 = b2+Eta*Eout; % 1*10
    end
end
```



<br>
